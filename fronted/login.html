<?php
session_start();
$message = "";

// Oracle DB connect
$conn = oci_connect('c##aman', 'root', "//localhost:1521/XE");

if (!$conn) {
  $e = oci_error();
  die("Connection failed: " . htmlentities($e['message']));
}

// If form submitted
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $email = strtolower(trim($_POST['email']));
    $password = trim($_POST['password']);

    // Validate inputs (basic)
    if (empty($email) || empty($password)) {
        $message = "❌ Please fill in all fields!";
    } else {
        // Query to check user
        $query = "SELECT * FROM users WHERE LOWER(email) = :email AND password = :password";
        $stmt = oci_parse($conn, $query);
        oci_bind_by_name($stmt, ":email", $email);
        oci_bind_by_name($stmt, ":password", $password);
        oci_execute($stmt);

        $row = oci_fetch_assoc($stmt);

        if ($row) {
            $_SESSION['email'] = $email;
            oci_free_statement($stmt);
            oci_close($conn);

            // ✅ Redirect only if login success
            header("Location: ./admin_new_bookings.php");
            exit();
        } else {
            $message = "❌ Incorrect email or password!";
        }
        oci_free_statement($stmt);
    }
    oci_close($conn);
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

<div class="min-h-screen flex flex-col items-center justify-center py-6 px-4">
  <div class="max-w-md w-full">
    <div class="p-8 rounded-2xl bg-white shadow">
      <h2 class="text-slate-900 text-center text-3xl font-semibold">Sign in</h2>

      <?php if (!empty($message)): ?>
        <p class="text-red-500 text-center mt-4 font-medium"><?= $message ?></p>
      <?php endif; ?>

      <form class="mt-8 space-y-6" method="POST" action="../fronted/new_booking.php">
        <div>
          <label class="text-slate-800 text-sm font-medium mb-2 block">Email</label>
          <input name="email" type="email" required class="w-full border px-4 py-3 rounded-md" placeholder="Enter your email" />
        </div>

        <div>
          <label class="text-slate-800 text-sm font-medium mb-2 block">Password</label>
          <input name="password" type="password" required class="w-full border px-4 py-3 rounded-md" placeholder="Enter your password" />
        </div>

        <div>
          <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md">
            Sign in
          </button>
        </div>

        <p class="text-center text-sm text-slate-800 mt-4">
          Don't have an account?
          <a href="register.html" class="text-blue-600 hover:underline">Register here</a>
        </p>
      </form>
    </div>
  </div>
</div>

</body>
</html>
